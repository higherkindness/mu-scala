<html><head><title>Mu-Scala: Patterns</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A purely functional library for building RPC endpoint-based services" /><meta name="og:image" content="/mu-scala/img/poster.png" /><meta name="image" property="og:image" content="/mu-scala/img/poster.png" /><meta name="og:title" content="Mu-Scala: Patterns" /><meta name="title" property="og:title" content="Mu-Scala: Patterns" /><meta name="og:site_name" content="Mu-Scala" /><meta name="og:url" content="https://higherkindness.github.io/mu-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="A purely functional library for building RPC endpoint-based services" /><link rel="icon" type="image/png" href="/mu-scala/img/favicon.png" /><meta name="twitter:title" content="Mu-Scala: Patterns" /><meta name="twitter:image" content="/mu-scala/img/poster.png" /><meta name="twitter:description" content="A purely functional library for building RPC endpoint-based services" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/mu-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/mu-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/mu-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/mu-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/mu-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/mu-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/mu-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/mu-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/mu-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/mu-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/mu-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/mu-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/mu-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/mu-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/mu-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/mu-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/mu-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/mu-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/mu-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/mu-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/mu-scala/highlight/styles/tomorrow-night-eighties.css" /><link rel="stylesheet" href="/mu-scala/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/mu-scala/" class="brand"><div class="brand-wrapper"></div><span>Mu-Scala</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/mu-scala/" title="Quickstart" class="">Quickstart</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/core-concepts" title="Core concepts" class="">Core concepts</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/streaming" title="Streaming" class="">Streaming</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/annotations" title="Annotations" class="">Annotations</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/generate-sources-from-idl" title="Generate sources from IDL" class="drop-nested">Generate sources from IDL</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/mu-scala/generate-sources-from-avro" title="Avro" class="">Avro</a> <a href="/mu-scala/generate-sources-from-proto" title="Protocol Buffers" class="">Protocol Buffers</a></div></div> <div class="sidebar-nav-item  "><a href="/mu-scala/idl-generation" title="IDL Generation" class="">IDL Generation</a></div> <div class="sidebar-nav-item active "><a href="/mu-scala/patterns" title="Patterns" class="active">Patterns</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/ssl-tls" title="SSL/TLS" class="">SSL/TLS</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/metrics-reporting" title="Metrics Reporting" class="">Metrics Reporting</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/decimal-migration-guide" title="Migration guide for decimal types" class="">Migration guide for decimal types</a></div> <div class="sidebar-nav-item  "><a href="/mu-scala/schema-evolution" title="Schema Evolution" class="drop-nested">Schema Evolution</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/mu-scala/schema-evolution/avro" title="Avro" class="">Avro</a> <a href="/mu-scala/schema-evolution/proto" title="Protocol Buffers" class="">Protocol Buffers</a></div></div> <div class="sidebar-nav-item  "><a href="/mu-scala/references" title="References" class="">References</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/higherkindness/mu-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/higherkindness/mu-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="higherkindness" data-github-repo="mu-scala"><div class="content-wrapper"><section><h1 id="patterns">Patterns</h1>

<p>So far so good, we haven’t seen too much code or implemented any business logic. In the previous sections we have seen some protocol definitions with Scala annotations and the generation of these definitions from IDL files. Finally, in this section, we are going to see how to complete our quickstart example. We’ll take a look at both sides, the server and the client.</p>

<h2 id="server">Server</h2>

<p>Predictably, generating the server code is just creating an implementation for your service algebra.</p>

<p>First, here’s our <code class="highlighter-rouge">Greeter</code> RPC protocol definition:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">higherkindness.mu.rpc.protocol._</span>

<span class="k">object</span> <span class="nc">service</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">monix.reactive.Observable</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">greeting</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="cm">/**
     * @param request Client request.
     * @return Server response.
     */</span>
    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span>

    <span class="cm">/**
     * @param request Single client request.
     * @return Stream of server responses.
     */</span>
    <span class="k">def</span> <span class="nf">lotsOfReplies</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span>

    <span class="cm">/**
     * @param request Stream of client requests.
     * @return Single server response.
     */</span>
    <span class="k">def</span> <span class="nf">lotsOfGreetings</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span>

    <span class="cm">/**
     * @param request Stream of client requests.
     * @return Stream of server responses.
     */</span>
    <span class="k">def</span> <span class="nf">bidiHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Next, our dummy <code class="highlighter-rouge">Greeter</code> server implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.Async</span>
<span class="k">import</span> <span class="nn">cats.syntax.applicative._</span>
<span class="k">import</span> <span class="nn">monix.execution.Scheduler</span>
<span class="k">import</span> <span class="nn">monix.reactive.Observable</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">class</span> <span class="nc">ServiceHandler</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Async</span><span class="o">](</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Scheduler</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nv">dummyObservableResponse</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Observable</span><span class="o">.</span><span class="py">fromIterable</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">5</span> <span class="nf">map</span> <span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">s</span><span class="s">"Reply $i"</span><span class="o">)))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span> <span class="k">=</span> <span class="s">"Good bye!"</span><span class="o">).</span><span class="py">pure</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">lotsOfReplies</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">dummyObservableResponse</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">lotsOfGreetings</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">request</span>
      <span class="o">.</span><span class="py">foldLeftL</span><span class="o">((</span><span class="mi">0</span><span class="o">,</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="s">""</span><span class="o">)))</span> <span class="o">{</span>
        <span class="nf">case</span> <span class="o">((</span><span class="n">i</span><span class="o">,</span> <span class="n">response</span><span class="o">),</span> <span class="n">currentRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="k">val</span> <span class="nv">currentReply</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="nv">response</span><span class="o">.</span><span class="py">reply</span>
          <span class="o">(</span>
            <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
            <span class="nv">response</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span>
              <span class="n">reply</span> <span class="k">=</span> <span class="n">s</span><span class="s">"$currentReply\nRequest ${currentRequest.greeting} -&gt; Response: Reply $i"</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">_2</span><span class="o">)</span>
      <span class="o">.</span><span class="py">toAsync</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">bidiHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">request</span>
      <span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span> <span class="o">=&gt;</span>
        <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Saving $request..."</span><span class="o">)</span>
        <span class="n">dummyObservableResponse</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="py">onErrorHandle</span> <span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
        <span class="k">throw</span> <span class="n">e</span>
      <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As you can see, we need a <code class="highlighter-rouge">monix.execution.Scheduler</code> implicit. This is needed in order to resolve the <code class="highlighter-rouge">cats.effect</code> instances for <code class="highlighter-rouge">Monix</code>.</p>

<p>That’s it! We have exposed a potential implementation on the server side.</p>

<h3 id="server-runtime">Server Runtime</h3>

<p>As you can see, the generic handler above requires <code class="highlighter-rouge">F</code> as the type parameter, which corresponds with our target <code class="highlighter-rouge">Monad</code> when interpreting our program. In this section, we will satisfy all the runtime requirements, in order to make our server runnable.</p>

<h3 id="creating-a-runtime">Creating a runtime</h3>

<p>Since <a href="https://github.com/higherkindness/mu">Mu</a> relies on <code class="highlighter-rouge">ConcurrentEffect</code> from the <a href="https://github.com/typelevel/cats-effect">cats-effect library</a>, we’ll need a runtime for executing our effects.</p>

<p>We’ll be using <code class="highlighter-rouge">IO</code> from <code class="highlighter-rouge">cats-effect</code>, but you can use any type that has a <code class="highlighter-rouge">ConcurrentEffect</code> instance.</p>

<p>For executing <code class="highlighter-rouge">IO</code> we need a <code class="highlighter-rouge">ContextShift[IO]</code> used for running <code class="highlighter-rouge">IO</code> instances and a <code class="highlighter-rouge">Timer[IO]</code> that is used for scheduling, let’s go ahead and create them.</p>

<p><em>Note:</em> You’d need an implicit <code class="highlighter-rouge">monix.execution.Scheduler</code> in the case you’re using Monix observables.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">EC</span><span class="k">:</span> <span class="kt">scala.concurrent.ExecutionContext</span> <span class="o">=</span>
    <span class="nv">scala</span><span class="o">.</span><span class="py">concurrent</span><span class="o">.</span><span class="py">ExecutionContext</span><span class="o">.</span><span class="py">Implicits</span><span class="o">.</span><span class="py">global</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">S</span><span class="k">:</span> <span class="kt">monix.execution.Scheduler</span> <span class="o">=</span> <span class="nv">monix</span><span class="o">.</span><span class="py">execution</span><span class="o">.</span><span class="py">Scheduler</span><span class="o">.</span><span class="py">Implicits</span><span class="o">.</span><span class="py">global</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">cats.effect.Timer</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span>     <span class="k">=</span> <span class="nv">cats</span><span class="o">.</span><span class="py">effect</span><span class="o">.</span><span class="py">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">cats.effect.ContextShift</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">cats</span><span class="o">.</span><span class="py">effect</span><span class="o">.</span><span class="py">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>As a side note, <code class="highlighter-rouge">CommonRuntime</code> will also be used later on for the client example program.</p>

<h3 id="server-bootstrap">Server Bootstrap</h3>

<p>For the server bootstrapping, remember to add the <code class="highlighter-rouge">mu-rpc-server</code> dependency to your build.</p>

<p>Now, we need to implicitly provide a runtime interpreter of our <code class="highlighter-rouge">ServiceHandler</code> tied to a specific type. In our case, we’ll use <code class="highlighter-rouge">cats.effects.IO</code>.</p>

<p>We also need to explicitly provide:
	* RPC port where the server will bootstrap.
	* The set of configurations we want to add to our <a href="https://grpc.io/">gRPC</a> server, like our <code class="highlighter-rouge">Greeter</code> service definition. All these configurations are aggregated in a <code class="highlighter-rouge">List[GrpcConfig]</code>. The full list of exposed settings is available in <a href="https://github.com/higherkindness/mu/blob/master/modules/server/src/main/scala/GrpcConfig.scala">this file</a>.</p>

<p>What else is needed? We just need to define a <code class="highlighter-rouge">main</code> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.server._</span>

<span class="k">object</span> <span class="nc">RPCServer</span> <span class="k">extends</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">greeterServiceHandler</span><span class="k">:</span> <span class="kt">Greeter</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServiceHandler</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="nv">runServer</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="n">grpcConfig</span> <span class="k">&lt;-</span> <span class="nv">Greeter</span><span class="o">.</span><span class="py">bindService</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
      <span class="n">server</span>     <span class="k">&lt;-</span> <span class="nv">GrpcServer</span><span class="o">.</span><span class="py">default</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="mi">8080</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="nc">AddService</span><span class="o">(</span><span class="n">grpcConfig</span><span class="o">)))</span>
      <span class="n">runServer</span>  <span class="k">&lt;-</span> <span class="nv">GrpcServer</span><span class="o">.</span><span class="py">server</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">server</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">runServer</span>

    <span class="nv">runServer</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The server will run on port <code class="highlighter-rouge">8080</code>.</p>

<h3 id="service-testing">Service testing</h3>

<p>Thanks to <code class="highlighter-rouge">withServerChannel</code> from the package <code class="highlighter-rouge">mu.rpc.testing.servers</code>, you will be able to run in-memory instances of the server, which is very convenient for testing purposes. Below, a very simple property-based test for proving <code class="highlighter-rouge">Greeter.sayHello</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.Resource</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.testing.servers.withServerChannel</span>
<span class="k">import</span> <span class="nn">io.grpc.</span><span class="o">{</span><span class="nc">ManagedChannel</span><span class="o">,</span> <span class="nc">ServerServiceDefinition</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.scalatestplus.scalacheck.Checkers</span>
<span class="k">import</span> <span class="nn">org.scalatest._</span>
<span class="k">import</span> <span class="nn">org.scalacheck.Gen</span>
<span class="k">import</span> <span class="nn">org.scalacheck.Prop.forAll</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">class</span> <span class="nc">ServiceSpec</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">Matchers</span> <span class="k">with</span> <span class="nc">Checkers</span> <span class="k">with</span> <span class="nc">OneInstancePerTest</span> <span class="k">with</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">greeterServiceHandler</span><span class="k">:</span> <span class="kt">Greeter</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServiceHandler</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">withClient</span><span class="o">[</span><span class="kt">Client</span>, <span class="kt">A</span><span class="o">](</span>
      <span class="n">serviceDef</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ServerServiceDefinition</span><span class="o">],</span>
      <span class="n">resourceBuilder</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ManagedChannel</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Client</span><span class="o">])(</span>
      <span class="n">f</span><span class="k">:</span> <span class="kt">Client</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
    <span class="nf">withServerChannel</span><span class="o">(</span><span class="n">serviceDef</span><span class="o">)</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">sc</span> <span class="k">=&gt;</span> <span class="nf">resourceBuilder</span><span class="o">(</span><span class="nc">IO</span><span class="o">(</span><span class="nv">sc</span><span class="o">.</span><span class="py">channel</span><span class="o">)))</span>
      <span class="o">.</span><span class="py">use</span><span class="o">(</span><span class="n">client</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">f</span><span class="o">(</span><span class="n">client</span><span class="o">)))</span>
      <span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>

  <span class="k">def</span> <span class="nf">sayHelloTest</span><span class="o">(</span><span class="n">requestGen</span><span class="k">:</span> <span class="kt">Gen</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">],</span> <span class="n">expected</span><span class="k">:</span> <span class="kt">HelloResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">Assertion</span> <span class="o">=</span>
    <span class="nf">withClient</span><span class="o">(</span>
      <span class="nv">Greeter</span><span class="o">.</span><span class="py">bindService</span><span class="o">[</span><span class="kt">IO</span><span class="o">],</span>
      <span class="nv">Greeter</span><span class="o">.</span><span class="py">clientFromChannel</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="k">_</span><span class="o">))</span> <span class="o">{</span> <span class="n">client</span> <span class="k">=&gt;</span>
        <span class="n">check</span> <span class="o">{</span>
          <span class="nf">forAll</span><span class="o">(</span><span class="n">requestGen</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
            <span class="nv">client</span><span class="o">.</span><span class="py">sayHello</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="py">unsafeRunSync</span><span class="o">()</span> <span class="o">==</span> <span class="n">expected</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>

  <span class="k">val</span> <span class="nv">requestGen</span><span class="k">:</span> <span class="kt">Gen</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">alphaStr</span> <span class="n">map</span> <span class="nc">HelloRequest</span>

  <span class="nf">test</span><span class="o">(</span><span class="s">"Get a valid response when a proper request is passed"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">sayHelloTest</span><span class="o">(</span><span class="n">requestGen</span><span class="o">,</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span> <span class="k">=</span> <span class="s">"Good bye!"</span><span class="o">))</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Greeter.bindService</code> is an auto-derived method which creates, behind the scenes, the binding service for <a href="https://grpc.io/">gRPC</a>. It requires <code class="highlighter-rouge">F[_]</code> as the type parameter, the target/concurrent monad, in our example: <code class="highlighter-rouge">cats.effects.IO</code>.</p>

<p>Running the test:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="nf">run</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServiceSpec</span><span class="o">)</span>
<span class="nc">ServiceSpec</span><span class="k">:</span>
<span class="kt">-</span> <span class="kt">Get</span> <span class="kt">a</span> <span class="kt">valid</span> <span class="kt">response</span> <span class="kt">when</span> <span class="kt">a</span> <span class="kt">proper</span> <span class="kt">request</span> <span class="kt">is</span> <span class="kt">passed</span>
</code></pre></div></div>

<h2 id="client">Client</h2>

<p><a href="https://github.com/higherkindness/mu">Mu</a> derives a client automatically based on the protocol. This is especially useful because you can distribute it depending on the protocol/service definitions. If you change something in your protocol definition, you will get a new client for free without having to write anything.</p>

<p>You will need to add either <code class="highlighter-rouge">mu-rpc-netty</code> or <code class="highlighter-rouge">mu-rpc-okhttp</code> to your build.</p>

<h3 id="client-runtime">Client Runtime</h3>

<p>Similarly in this section, just like we saw for the server, we are defining all the client runtime configurations needed for communication with the server.</p>

<h3 id="creating-a-runtime-1">Creating a runtime</h3>

<p>In our example, we are going to use the same runtime described for the server. Remember we’re relying on the <code class="highlighter-rouge">ConcurrentEffect</code>, so you can use any type that has a <code class="highlighter-rouge">ConcurrentEffect</code> instance.</p>

<h3 id="transport-implicits">Transport Implicits</h3>

<p>First, we need to configure how the client will reach the server in terms of the transport layer. There are two supported methods:</p>

<ul>
  <li>By Address (host/port): enables us to create a channel with the target’s address and port number.</li>
  <li>By Target: we can create a channel with a target string, which can be either a valid <a href="https://grpc.io/grpc-java/javadoc/io/grpc/NameResolver.html">NameResolver</a>-compliant URI or an authority string.</li>
</ul>

<p>Additionally, we can add more optional configurations that can be used when the connection occurs. All the options are available <a href="https://github.com/higherkindness/mu/blob/48b8578cbafc59dc59e61e93c13fdb4709b7e540/modules/client/src/main/scala/ManagedChannelConfig.scala">here</a>.</p>

<p>Given the transport settings and a list of optional configurations, we can create the <a href="https://grpc.io/grpc-java/javadoc/io/grpc/ManagedChannel.html">ManagedChannel.html</a> object, using the <code class="highlighter-rouge">ManagedChannelInterpreter</code> builder.</p>

<p>As we will see shortly in our example, we are going relay on the default behaviour passing directly the <code class="highlighter-rouge">ChannelFor</code> to the client builder.</p>

<p>So, taking into account all of that, how would our code look?</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Resource</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc._</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.config._</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.config.channel._</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">object</span> <span class="nc">gclient</span> <span class="o">{</span>

  <span class="k">trait</span> <span class="nc">Implicits</span> <span class="k">extends</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

    <span class="k">val</span> <span class="nv">channelFor</span><span class="k">:</span> <span class="kt">ChannelFor</span> <span class="o">=</span>
      <span class="nc">ConfigForAddress</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"rpc.host"</span><span class="o">,</span> <span class="s">"rpc.port"</span><span class="o">).</span><span class="py">unsafeRunSync</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="nv">serviceClient</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Greeter</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span>
      <span class="nv">Greeter</span><span class="o">.</span><span class="py">client</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">channelFor</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">implicits</span> <span class="k">extends</span> <span class="nc">Implicits</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Notes</strong>:</p>

<ul>
  <li>In the code above, <code class="highlighter-rouge">host</code> and <code class="highlighter-rouge">port</code> would be read from an application configuration file.</li>
  <li>To be able to use the <code class="highlighter-rouge">ConfigForAddress</code> helper, you need to add the <code class="highlighter-rouge">mu-config</code> dependency to your build.</li>
</ul>

<h3 id="client-program">Client Program</h3>

<p>Once we have our runtime configuration defined as above, everything gets easier on the client side. This is an example of a client application, following our dummy quickstart:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">service._</span>
<span class="k">import</span> <span class="nn">gclient.implicits._</span>

<span class="k">object</span> <span class="nc">RPCDemoApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="nv">hello</span> <span class="k">=</span> <span class="nv">serviceClient</span><span class="o">.</span><span class="py">use</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">sayHello</span><span class="o">(</span><span class="nc">HelloRequest</span><span class="o">(</span><span class="s">"foo"</span><span class="o">))).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">result</span> <span class="k">=&gt;</span>
      <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Result = $result"</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="nv">hello</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<h2 id="more">More</h2>

<p>You can check a full explanation about defining messages and services <a href="https://www.47deg.com/blog/mu-rpc-defining-messages-and-services/">here</a> or some examples <a href="https://github.com/higherkindness/mu/tree/master/modules/examples">here</a>.</p>

</section></div></div></div></div><script src="/mu-scala/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/protobuf.min.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','protobuf']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/mu'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/mu-scala/js/docs.js"></script></body></html>